# FILE: ios/App/fastlane/Fastfile
default_platform(:ios)

platform :ios do
  desc "Build and upload to TestFlight (avoid gym/xcodeproj parser issues)"
  lane :beta do
    setup_ci

    api_key = app_store_connect_api_key(
      key_id: ENV.fetch("APP_STORE_CONNECT_API_KEY_ID"),
      issuer_id: ENV.fetch("APP_STORE_CONNECT_API_ISSUER_ID"),
      key_content: ENV.fetch("APP_STORE_CONNECT_API_KEY"),
      is_key_content_base64: true,
      in_house: false
    )

    match(
      type: "appstore",
      readonly: false,
      api_key: api_key,
      git_url: ENV.fetch("MATCH_GIT_URL"),
      git_basic_authorization: ENV.fetch("MATCH_GIT_BASIC_AUTHORIZATION")
    )

    increment_build_number(
      build_number: Time.now.strftime("%Y%m%d%H%M")
    )

    mapping = Actions.lane_context[SharedValues::MATCH_PROVISIONING_PROFILE_MAPPING]
    bundle_id = "com.vyrlabs.app"
    profile_name = mapping[bundle_id]

    UI.user_error!("No provisioning profile mapping found for #{bundle_id}") if profile_name.to_s.strip.empty?

    team_id = ENV.fetch("APP_STORE_CONNECT_TEAM_ID")

    # Paths
    project_path = "App.xcodeproj"
    scheme = "App"
    archive_path = File.expand_path("build/#{scheme}.xcarchive", Dir.pwd)
    export_dir = File.expand_path("build/export", Dir.pwd)
    export_plist = File.expand_path("build/ExportOptions.plist", Dir.pwd)

    # Ensure build dirs
    sh("mkdir -p build")
    sh("mkdir -p #{export_dir.shellescape}")

    # ExportOptions.plist (manual signing + explicit profile mapping)
    plist_content = <<~PLIST
      <?xml version="1.0" encoding="UTF-8"?>
      <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
      <plist version="1.0">
      <dict>
        <key>method</key>
        <string>app-store</string>
        <key>signingStyle</key>
        <string>manual</string>
        <key>teamID</key>
        <string>#{team_id}</string>
        <key>provisioningProfiles</key>
        <dict>
          <key>#{bundle_id}</key>
          <string>#{profile_name}</string>
        </dict>
        <key>uploadBitcode</key>
        <false/>
        <key>compileBitcode</key>
        <false/>
      </dict>
      </plist>
    PLIST

    File.write(export_plist, plist_content)

    # Clean previous archive if exists
    sh("rm -rf #{archive_path.shellescape}")

    # 1) Archive
    sh([
      "set -o pipefail &&",
      "xcodebuild",
      "-project #{project_path.shellescape}",
      "-scheme #{scheme.shellescape}",
      "-configuration Release",
      "-archivePath #{archive_path.shellescape}",
      "CODE_SIGN_STYLE=Manual",
      "DEVELOPMENT_TEAM=#{team_id}",
      "CODE_SIGN_IDENTITY='Apple Distribution'",
      "PROVISIONING_PROFILE_SPECIFIER='#{profile_name}'",
      "archive"
    ].join(" "))

    # 2) Export IPA
    sh([
      "set -o pipefail &&",
      "xcodebuild",
      "-exportArchive",
      "-archivePath #{archive_path.shellescape}",
      "-exportPath #{export_dir.shellescape}",
      "-exportOptionsPlist #{export_plist.shellescape}"
    ].join(" "))

    ipa_path = Dir[File.join(export_dir, "*.ipa")].first
    UI.user_error!("IPA not found in #{export_dir}") if ipa_path.to_s.strip.empty?

    # 3) Upload to TestFlight
    upload_to_testflight(
      api_key: api_key,
      ipa: ipa_path
    )
  end
end
