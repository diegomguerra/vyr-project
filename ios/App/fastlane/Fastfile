# FILE: ios/App/fastlane/Fastfile
default_platform(:ios)

platform :ios do
  desc "Build and upload to TestFlight (avoid gym/xcodeproj parser issues)"
  lane :beta do
    setup_ci

    api_key = app_store_connect_api_key(
      key_id: ENV.fetch("APP_STORE_CONNECT_API_KEY_ID"),
      issuer_id: ENV.fetch("APP_STORE_CONNECT_API_ISSUER_ID"),
      key_content: ENV.fetch("APP_STORE_CONNECT_API_KEY"),
      is_key_content_base64: true,
      in_house: false
    )

    match(
      type: "appstore",
      readonly: false,
      api_key: api_key,
      git_url: ENV.fetch("MATCH_GIT_URL"),
      git_basic_authorization: ENV.fetch("MATCH_GIT_BASIC_AUTHORIZATION")
    )

    increment_build_number(
      build_number: Time.now.strftime("%Y%m%d%H%M")
    )

    # -----------------------------
    # Archive (executar no diret√≥rio correto)
    # -----------------------------
    Dir.chdir("..") do
      sh([
        "set -o pipefail &&",
        "xcodebuild",
        "-project App.xcodeproj",
        "-scheme App",
        "-configuration Release",
        "-archivePath fastlane/build/App.xcarchive",
        "CODE_SIGN_STYLE=Manual",
        "CODE_SIGN_IDENTITY='Apple Distribution'",
        "DEVELOPMENT_TEAM=#{ENV['APP_STORE_CONNECT_TEAM_ID']}",
        "PROVISIONING_PROFILE_SPECIFIER='match AppStore com.vyrlabs.app 1770256240'",
        "archive"
      ].join(" "))
    end

    # -----------------------------
    # Export IPA
    # -----------------------------
    Dir.chdir("..") do
      sh([
        "set -o pipefail &&",
        "xcodebuild",
        "-exportArchive",
        "-archivePath fastlane/build/App.xcarchive",
        "-exportPath fastlane/build/export",
        "-exportOptionsPlist fastlane/ExportOptions.plist"
      ].join(" "))
    end

    ipa_path = Dir[File.join("build/export", "*.ipa")].first
    UI.user_error!("IPA not found in build/export") if ipa_path.to_s.strip.empty?

    # 3) Upload to TestFlight
    upload_to_testflight(
      api_key: api_key,
      ipa: ipa_path
    )
  end
end
