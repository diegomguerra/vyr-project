default_platform(:ios)

platform :ios do
  desc "Build + Deploy to TestFlight"
  lane :beta do
    setup_ci

    # App Store Connect API Key (Hash) - REQUIRED for match/pilot in CI
  api_key = app_store_connect_api_key(
  key_id: ENV["APP_STORE_CONNECT_API_KEY_ID"],
  issuer_id: ENV["APP_STORE_CONNECT_API_ISSUER_ID"],
  key_content: ENV["APP_STORE_CONNECT_API_KEY"],
  is_key_content_base64: true
)

match(
  type: "appstore",
  readonly: false,
  api_key: api_key
)

    increment_build_number(
      build_number: Time.now.strftime("%Y%m%d%H%M")
    )

    # Build + Archive
    mapping = Actions.lane_context[SharedValues::MATCH_PROVISIONING_PROFILE_MAPPING]
    profile_name = mapping["com.vyrlabs.app"]
    UI.user_error!("Missing provisioning profile mapping for com.vyrlabs.app") if profile_name.to_s.empty?

    xcargs = [
      "DEVELOPMENT_TEAM=#{ENV['APP_STORE_CONNECT_TEAM_ID']}",
      "CODE_SIGN_STYLE=Manual",
      "CODE_SIGN_IDENTITY=\\\"Apple Distribution\\\"",
      "PROVISIONING_PROFILE_SPECIFIER=\\\"#{profile_name}\\\""
    ].join(" ")

    gym(
      scheme: "App",
      configuration: "Release",
      export_method: "app-store",
      clean: true,
      destination: "generic/platform=iOS",
      export_options: {
        signingStyle: "manual",
        teamID: ENV["APP_STORE_CONNECT_TEAM_ID"],
        provisioningProfiles: mapping
      },
      xcargs: xcargs,
      export_xcargs: xcargs
    )


    pilot(
      skip_waiting_for_build_processing: true
    )
  end
end
